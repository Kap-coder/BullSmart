{% extends 'Bull/base.html' %}
{% load bulletin_tags %}
{% block content %}
<div data-ajax-content>
<h2>Bulletins de classe</h2>

{# Statistiques globales par salle #}
<div class="row mb-4">
  {% for stat in classroom_stats %}
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ stat.name }}</h5>
          <p class="card-text">Bulletins g√©n√©r√©s : <strong>{{ stat.bulletins_count }}</strong> / <strong>{{ stat.total_students }}</strong></p>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

{# Affichage des messages d'erreur #}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message|safe }}</div>
  {% endfor %}
{% endif %}

<form method="get" class="mb-4">
  <div class="row">
    <div class="col-md-4">
      <label>Ann√©e scolaire</label>
      <select name="schoolyear" class="form-control">
        <option value="">-- S√©lectionner --</option>
        {% for sy in schoolyears %}
          <option value="{{ sy.id }}" {% if selected_schoolyear == sy.id|stringformat:'s' %}selected{% endif %}>{{ sy.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label>S√©quence</label>
      <select name="sequence" class="form-control">
        <option value="">-- S√©lectionner --</option>
        {% for seq in sequences %}
          <option value="{{ seq.id }}" {% if selected_sequence == seq.id|stringformat:'s' %}selected{% endif %}>{{ seq.name }} ({{ seq.term.name }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label>Classe</label>
      <select name="classroom" class="form-control">
        <option value="">-- S√©lectionner --</option>
        {% for c in classrooms %}
          <option value="{{ c.id }}" {% if selected_classroom == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <button type="submit" class="btn btn-primary mt-3">Filtrer</button>
</form>

{% if selected_classroom_obj and selected_sequence_obj %}
  <h4>Classe : {{ selected_classroom_obj.name }} | S√©quence : {{ selected_sequence_obj.name }} | Prof principal : {{ selected_classroom_obj.head_teacher }}</h4>
  <div class="alert alert-info mb-3">
    Bulletins g√©n√©r√©s : <strong>{{ bulletins|length }}</strong> / <strong>{{ students|length }}</strong> √©l√®ves
  </div>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>√âl√®ve</th>
        {% for subject in subjects %}
          <th>{{ subject.name }}</th>
        {% endfor %}
        <th>Bulletin</th>
      </tr>
    </thead>
    <tbody>
      {% for row in student_grades %}
        <tr>
          <td>{{ row.student.last_name }} {{ row.student.first_name }}</td>
          {% for grade in row.grades %}
            <td class="text-center">
              {% if grade %}
                {% if grade.status == 'validated' %}
                  <span class="badge badge-success">üü¢</span>
                {% elif grade.status == 'locked' %}
                  <span class="badge badge-success">üîí</span>
                {% else %}
                  <span class="badge badge-danger">‚ùå</span>
                {% endif %}
              {% else %}
                <span class="badge badge-danger">‚ùå</span>
              {% endif %}
            </td>
          {% endfor %}
          <td class="text-center">
            {% with bulletin=bulletins|get_bulletin_for_student:row.student %}
              {% if bulletin %}
                <a href="{% url 'bulletin_detail' student_id=row.student.id sequence_id=selected_sequence %}" class="btn btn-info btn-sm" data-no-ajax>Voir bulletin</a>
              {% else %}
                <span class="badge badge-danger">‚ùå</span>
              {% endif %}
            {% endwith %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}


{# 4. Hide generate button if all students have bulletins, show detail button instead #}
{% if can_calculate %}
  {% if students|length > 0 and bulletins|length == students|length %}
  <a href="{% url 'bulletin_stats' %}?sequence={{ selected_sequence }}&classroom={{ selected_classroom }}" class="btn btn-info mb-3" data-no-ajax>D√©tail</a>
  {% else %}
    <form method="post" action="{% url 'generate_bulletins' %}" data-no-ajax>
      {% csrf_token %}
      <input type="hidden" name="schoolyear" value="{{ selected_schoolyear }}">
      <input type="hidden" name="sequence" value="{{ selected_sequence }}">
      <input type="hidden" name="classroom" value="{{ selected_classroom }}">
      <button type="submit" class="btn btn-success mb-3">G√©n√©rer les bulletins</button>
    </form>
  {% endif %}
{% endif %}

{# G√©n√©ration bulletins trimestriels et annuels #}
{% if selected_classroom_obj and selected_schoolyear_obj %}
  <div class="card mt-5">
    <div class="card-body">
      <h5 class="card-title">G√©n√©rer les bulletins consolid√©s</h5>
      <form method="post" action="{% url 'generate_bulletins_trimester' %}" class="form-inline mb-3">
        {% csrf_token %}
        <input type="hidden" name="classroom" value="{{ selected_classroom }}">
        <input type="hidden" name="schoolyear" value="{{ selected_schoolyear }}">
        <label for="trimester" class="mr-2">Trimestre :</label>
        <select name="trimester" id="trimester" class="form-control mr-2">
          {% for term in terms %}
            {% if term.school_year_id == selected_schoolyear_obj.id %}
              <option value="{{ term.id }}">{{ term.name }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">G√©n√©rer bulletin trimestriel</button>
      </form>
      <form method="post" action="{% url 'generate_bulletins_annual' %}" class="form-inline">
        {% csrf_token %}
        <input type="hidden" name="classroom" value="{{ selected_classroom }}">
        <input type="hidden" name="schoolyear" value="{{ selected_schoolyear }}">
        <button type="submit" class="btn btn-success">G√©n√©rer bulletin annuel</button>
      </form>
    </div>
  </div>
{% endif %}

</div>
{% endblock %}
