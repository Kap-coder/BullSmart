<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- CDN Bootstrap & Chart.js -->
    {% comment %} <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> {% endcomment %}
        <meta charset="UTF-8">
        <title>SmartBull</title>
        {% load static %}
        <link rel="manifest" href="{% static 'manifest.json' %}">
        <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
        <link rel="stylesheet" href="{% static 'css/all.css' %}">
        <script src="{% static 'js/bootstrap.js' %}"></script>
        <script src="{% static 'js/chart.js' %}"></script>
        <script src="{% static 'js/all.js' %}"></script>
        <script>
            // Enregistrement du service worker PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('{% static "service-worker.js" %}')
                        .then(function(reg) {
                            // Service worker enregistré
                        }).catch(function(err) {
                            console.warn('Service worker erreur:', err);
                        });
                });
            }
        </script>
    <style>
        /* Nom utilisateur header */
        .header .d-flex.align-items-center.gap-3 span {
            color: var(--text-light);
            text-decoration: none !important;
        }
        /* Barre latérale : pas de soulignement */
        .sidebar .nav-link, .sidebar .nav-link span, .sidebar .nav-link i {
            text-decoration: none !important;
        }
        body {
            min-height: 100vh;
            overflow-x: hidden;
        }
        :root {
            --primary: #2D5DA1;
            --secondary: #0F2557;
            --bg-light: #F5F5F5;
            --text-dark: #424242;
            --text-light: #fff;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
            --info: #00BCD4;
        }
        .header {
            background: var(--primary);
            color: var(--text-light);
            padding: 0.75rem 2rem;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1030;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header .d-flex.align-items-center.gap-3 {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .sidebar {
            background: var(--secondary);
            color: var(--text-light);
            position: fixed;
            top: 64px;
            left: 0;
            height: calc(100vh - 64px);
            width: 220px;
            transition: width 0.2s;
            z-index: 1020;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--secondary);
        }
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        .sidebar::-webkit-scrollbar-track {
            background: var(--secondary);
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar .nav {
            display: flex;
            flex-direction: column;
            padding-left: 0;
            margin-bottom: 0;
            list-style: none;
        }
        .sidebar .nav-item {
            margin: 0;
            padding: 0;
        }
        .sidebar .nav-link {
            color: var(--text-light);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-radius: 0 20px 20px 0;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar .nav-link.active {
            background: var(--primary);
            color: var(--text-light);
            font-weight: bold;
        }
        .sidebar .nav-link i {
            font-size: 1.2rem;
        }
        .sidebar.collapsed .nav-link span {
            display: none;
        }
        .sidebar-toggler {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            width: 100%;
            text-align: right;
        }
        main {
            margin-top: 64px;
            margin-left: 220px;
            transition: margin-left 0.2s;
            min-height: calc(100vh - 64px);
            background: var(--bg-light);
            color: var(--text-dark);
        }
        .sidebar.collapsed ~ main {
            margin-left: 60px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: #fff;
            border: 2px solid #fff;
        }
        .dropdown-menu {
            min-width: 180px;
        }
        .chatbot-btn {
            background: #fff;
            color: var(--primary);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
        }
        .chatbot-panel {
            position: fixed;
            top: 64px;
            right: 0;
            width: 350px;
            height: calc(100vh - 64px);
            background: #fff;
            box-shadow: -2px 0 8px rgba(0,0,0,0.08);
            z-index: 1050;
            display: none;
            flex-direction: column;
        }
        .chatbot-panel.open {
            display: flex;
        }
        .chatbot-header {
            background: var(--primary);
            color: var(--text-light);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chatbot-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem 1rem;
        }
        .chatbot-body .bot-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .chatbot-footer {
            padding: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            gap: 0.5rem;
        }
        .chatbot-footer input {
            flex: 1;
        }
        @media (max-width: 992px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 0.5rem 1rem;
            }
            .header .d-flex.align-items-center.gap-3 {
                flex-direction: row;
                width: 100%;
                justify-content: space-between;
                gap: 1rem;
            }
            .sidebar {
                width: 60px;
                top: 56px;
                height: calc(100vh - 56px);
            }
            main {
                margin-left: 60px;
                padding: 1rem 0.5rem;
            }
            .chatbot-panel { width: 100vw; }
        }
        @media (max-width: 576px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 0.25rem 0.5rem;
            }
            .sidebar {
                width: 0;
                left: -220px;
                position: absolute;
                height: 100vh;
                z-index: 2000;
                box-shadow: 2px 0 8px rgba(0,0,0,0.08);
            }
            .sidebar.open {
                left: 0;
                width: 220px;
            }
            main {
                margin-left: 0;
                padding: 0.5rem 0.2rem;
            }
            .sidebar-toggler {
                display: block;
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 2100;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="d-flex align-items-center gap-3">
            <h2 class="mb-0">SmartBull</h2>
        </div>
        <div class="d-flex align-items-center gap-3">
            {% if user.is_authenticated %}
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center gap-2 text-white text-decoration-none" id="avatarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="https://ui-avatars.com/api/?name={{ user.get_full_name|urlencode }}&size=128" alt="avatar" class="avatar">
                        <span>{{ user.get_full_name }}</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="avatarDropdown">
                        <li><a class="dropdown-item" href="/profile/">Profil</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout/">Déconnexion</a></li>
                    </ul>
                </div>
            {% else %}
                <a href="/login/" class="btn btn-light btn-sm">Connexion</a>
            {% endif %}
            <button class="chatbot-btn" id="chatbotOpenBtn" title="Chatbot"><i class="fas fa-robot"></i></button>
        </div>
    </div>
    <nav class="sidebar" id="sidebar">
    <button class="sidebar-toggler" id="sidebarToggleBtn"><i class="fas fa-bars"></i></button>
        <ul class="nav flex-column">
            {% if user.is_authenticated %}
                <li class="nav-item"><a class="nav-link {% if request.path == '/profile/' %}active{% endif %}" href="/profile/"><i class="fas fa-user"></i> <span>Profil</span></a></li>
                {% if user.role == 'admin' or user.role == 'secretary' %}
                    <li class="nav-item"><a class="nav-link {% if request.path == '/dashboard/' %}active{% endif %}" href="/dashboard/"><i class="fas fa-chart-line"></i> <span>Tableau de bord</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/users/' %}active{% endif %}" href="/users/"><i class="fas fa-users"></i> <span>Utilisateurs</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/students/' %}active{% endif %}" href="/students/"><i class="fas fa-user-graduate"></i> <span>Élèves</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/teachers/' %}active{% endif %}" href="/teachers/"><i class="fas fa-chalkboard-teacher"></i> <span>Enseignants</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/classes/' %}active{% endif %}" href="/classes/"><i class="fas fa-school"></i> <span>Classes</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/subjects/' %}active{% endif %}" href="/subjects/"><i class="fas fa-book"></i> <span>Matières</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/notes/' %}active{% endif %}" href="{% url 'subject_card_list' %}"><i class="fas fa-pencil-alt"></i> <span>Notes</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/bulletins/' %}active{% endif %}" href="/bulletins/"><i class="fas fa-file-alt"></i> <span>Bulletins</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/parameters/' %}active{% endif %}" href="/parameters/"><i class="fas fa-cogs"></i> <span>Paramètres</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/my-bulletin/' %}active{% endif %}" href="/my-bulletin/"><i class="fas fa-file-signature"></i> <span>Consulter bulletin</span></a></li>
                {% elif user.role == 'teacher' %}
                    <li class="nav-item"><a class="nav-link {% if request.path == '/grades/' %}active{% endif %}" href="/grades/"><i class="fas fa-pencil-alt"></i> <span>Notes</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path == '/bulletins/' %}active{% endif %}" href="/bulletins/"><i class="fas fa-file-alt"></i> <span>Bulletins</span></a></li>
                {% elif user.role == 'parent' or user.role == 'student' %}
                    <li class="nav-item"><a class="nav-link {% if request.path == '/my-bulletin/' %}active{% endif %}" href="/my-bulletin/"><i class="fas fa-file-signature"></i> <span>Consulter bulletin</span></a></li>
                {% endif %}
            {% endif %}
        </ul>
    </nav>
    <main class="flex-fill p-4" style="padding: 20px;" id="mainContent">
        {% block content %}{% endblock %}
    </main>
    <div class="chatbot-panel" id="chatbotPanel">
        <div class="chatbot-header">
            <i class="fas fa-robot"></i>
            <span>SmartBull Bot</span>
            <button class="btn btn-sm btn-light ms-auto" id="chatbotCloseBtn"><i class="fas fa-times"></i></button>
        </div>
        <div class="chatbot-body">
            <span class="bot-icon"><i class="fas fa-robot"></i></span>
            <div class="text-center mb-3">Poser moi une question ou demander une action</div>
        </div>
        <form class="chatbot-footer">
            <input type="text" class="form-control" placeholder="Votre message...">
            <button type="submit" class="btn btn-primary">Envoyer</button>
        </form>
    </div>
    <script src="{% static 'js/bootstrap.js' %}"></script>
    <script src="{% static 'js/chart.js' %}"></script>
    <script src="{% static 'js/all.js' %}"></script>
    <script>
        // Sidebar toggle + persistance
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const mainContent = document.getElementById('mainContent');
        // Appliquer l'état au chargement
        if(localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            mainContent.style.marginLeft = '60px';
        }
        sidebarToggleBtn.addEventListener('click', function() {
            if(window.innerWidth <= 576) {
                sidebar.classList.toggle('open');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                if(sidebar.classList.contains('collapsed')) {
                    mainContent.style.marginLeft = '60px';
                    localStorage.setItem('sidebarCollapsed', 'true');
                } else {
                    mainContent.style.marginLeft = '220px';
                    localStorage.setItem('sidebarCollapsed', 'false');
                }
            }
        });
        // Fermer la sidebar mobile au clic en dehors
        document.addEventListener('click', function(e) {
            if(window.innerWidth <= 576 && sidebar.classList.contains('open')) {
                if(!sidebar.contains(e.target) && !sidebarToggleBtn.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });
        // Chatbot panel
        const chatbotPanel = document.getElementById('chatbotPanel');
        const chatbotOpenBtn = document.getElementById('chatbotOpenBtn');
        const chatbotCloseBtn = document.getElementById('chatbotCloseBtn');
        chatbotOpenBtn.addEventListener('click', function() {
            chatbotPanel.classList.add('open');
        });
        chatbotCloseBtn.addEventListener('click', function() {
            chatbotPanel.classList.remove('open');
        });
        // Navigation AJAX + mise à jour du menu actif
        function setActiveMenu(url) {
            document.querySelectorAll('.sidebar .nav-link').forEach(function(link) {
                link.classList.remove('active');
                if(link.getAttribute('href') === url) {
                    link.classList.add('active');
                }
            });
        }
        function onAjaxContentLoaded() {
            // Dashboard : recharger les graphiques si présents
            if(document.getElementById('evolutionChart')) {
                // Recharger le script dashboard si présent
                if(typeof window.initDashboardCharts === 'function') window.initDashboardCharts();
            }
            // Bulletins : réattacher les événements JS (modals, boutons, etc.)
            if(document.getElementById('bulletinDetailBtn')) {
                document.querySelectorAll('#bulletinDetailBtn').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        // Logique d'affichage du détail (modal, etc.)
                        // ...
                    });
                });
            }
            // ...ajouter ici d'autres initialisations JS nécessaires...
        }
        function ajaxNavigate(url, addToHistory=true) {
            fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
                .then(response => {
                    if(!response.ok) throw new Error('Erreur chargement');
                    return response.text();
                })
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const block = tempDiv.querySelector('[data-ajax-content]');
                    if(block) {
                        mainContent.innerHTML = block.innerHTML;
                        setActiveMenu(url);
                        if(addToHistory) history.pushState({url:url}, '', url);
                        document.title = tempDiv.querySelector('title') ? tempDiv.querySelector('title').innerText : 'SmartBull';
                        onAjaxContentLoaded();
                        // Mise à jour du cache PWA après navigation AJAX
                        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                          navigator.serviceWorker.controller.postMessage({type: 'update-cache', url: url});
                        }
                    } else {
                        mainContent.innerHTML = '<div class="alert alert-danger">Erreur chargement contenu.</div>';
                    }
                })
                .catch(() => {
                    mainContent.innerHTML = '<div class="alert alert-danger">Erreur chargement contenu.</div>';
                });
        }
        // Intercepter les clics menu
        document.querySelectorAll('.sidebar .nav-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                const url = link.getAttribute('href');
                if(url && url.startsWith('/')) {
                    e.preventDefault();
                    ajaxNavigate(url);
                }
            });
        });
        // Gérer retour arrière
        window.addEventListener('popstate', function(e) {
            if(e.state && e.state.url) {
                ajaxNavigate(e.state.url, false);
            }
        });
    </script>
</body>
</html>
