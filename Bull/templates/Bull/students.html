{% extends 'Bull/base.html' %}
{% load static %}
{% block content %}
<div data-ajax-content>
  <style>
    .card-custom {
      padding: 1.5rem;
    }
  </style>
<!-- Card descriptive en haut -->
<div class="card card-custom mb-4" style="background: #f5f8fc; border-radius: 1.1rem; box-shadow: 0 2px 12px rgba(45,93,161,0.07); border: 1px solid #e3e8f0;">
  <div class="card-body py-3 px-4">
    <h2 class="mb-2" style="color:#2D5DA1;font-weight:700;">Gestion des élèves</h2>
    <p class="mb-0" style="color:#424242;font-size:1.08rem;">Retrouvez ici la liste complète des élèves, filtrez par classe ou recherchez par nom, prénom ou matricule. Vous pouvez ajouter, importer ou exporter les élèves facilement.</p>
  </div>
</div>
<!-- Modal Import Excel -->
<div id="customImportModal" class="custom-modal">
  <div class="custom-modal-content">
    <span class="custom-modal-close" onclick="closeModal('customImportModal')">&times;</span>
    <h4 class="mb-2" style="color:#2D5DA1;font-weight:700;">Importer élèves via Excel</h4>
    {% if import_errors %}
      <div class="custom-alert custom-alert-danger">
        <strong>Erreur d'importation :</strong><br>
        {% for err in import_errors %}
          <div>{{ err }}</div>
        {% endfor %}
      </div>
    {% endif %}
    <form method="post" enctype="multipart/form-data" action="/students/import/">
      {% csrf_token %}
      <div class="mb-3">
        <label for="excelFile" class="form-label">Fichier Excel (.xlsx)</label>
        <input type="file" class="form-control" id="excelFile" name="excel_file" required>
      </div>
      <div class="custom-alert custom-alert-info">
        <strong>Format attendu :</strong><br>
        <code>matricule, nom, prenom, genre, date_naissance (YYYY-MM-DD), lieu_naissance, photo, classe, redouble (oui/non)</code><br>
        <span style="color:#F44336;">Le fichier doit être un vrai fichier Excel (.xlsx) et non un autre format.</span>
      </div>
      <button type="submit" class="btn btn-primary w-100">Importer</button>
    </form>
  </div>
</div>

<div id="customExportModal" class="custom-modal">
  <div class="custom-modal-content">
    <span class="custom-modal-close" onclick="closeModal('customExportModal')">&times;</span>
    <h4 class="mb-2" style="color:#2D5DA1;font-weight:700;">Exporter élèves par classe</h4>
    <form method="get" action="{% url 'export_students' %}">
      <div class="mb-3">
        <label for="classExport" class="form-label">Classe</label>
        <select name="classroom" id="classExport" class="form-select" required>
          {% for c in classes %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Format d'export</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="format" id="exportExcel" value="excel" checked>
          <label class="form-check-label" for="exportExcel">Excel</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="format" id="exportPDF" value="pdf">
          <label class="form-check-label" for="exportPDF">PDF</label>
        </div>
      </div>
      <button type="submit" class="btn btn-info w-100">Exporter</button>
    </form>
  </div>
</div>
<div class="" style="margin-top: 10px; margin-bottom: 10px;">
  <a href="/students/add/" class="btn btn-success"><i class="bi bi-person-plus"></i> Ajouter élève</a>
  <button class="btn btn-primary" onclick="openModal('customImportModal')"><i class="bi bi-upload"></i> Importer Excel</button>
  <button class="btn btn-info" onclick="openModal('customExportModal')"><i class="bi bi-download"></i> Exporter</button>
</div>
<form method="get" class="row g-3 mb-2">
	<div class="col-md-4">
		<select name="class" class="form-select">
			<option value="">-- Toutes les classes --</option>
			{% for c in classes %}
				<option value="{{ c.id }}" {% if selected_class == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="col-md-4">
		<input type="text" name="search" class="form-control" placeholder="Nom, prénom ou matricule" value="{{ search }}">
	</div>
	<div class="col-md-4">
		<button type="submit" class="btn btn-primary">Filtrer</button>
		<a href="/students/" class="btn btn-secondary">Réinitialiser</a>
	</div>
</form>

<table class="table table-striped mt-2">
<style>
.custom-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(45,93,161,0.13);
  align-items: center; justify-content: center;
}
.custom-modal.show {
  display: flex;
  animation: fadeInModal 0.2s;
}
@keyframes fadeInModal {
  from { opacity: 0; } to { opacity: 1; }
}
.custom-modal-content {
  background: #fff;
  border-radius: 1.1rem;
  box-shadow: 0 8px 32px rgba(45,93,161,0.18);
  padding: 2rem 1.5rem 1.2rem 1.5rem;
  min-width: 320px;
  max-width: 98vw;
  width: 100%;
  max-width: 420px;
  position: relative;
}
.custom-modal-close {
  position: absolute;
  top: 1.1rem; right: 1.2rem;
  font-size: 2rem;
  color: #2D5DA1;
  cursor: pointer;
  font-weight: 700;
  transition: color 0.2s;
}
.custom-modal-close:hover {
  color: #F44336;
}
.custom-alert {
  border-radius: 0.7rem;
  padding: 0.7rem 1rem;
  margin-bottom: 1rem;
  font-size: 1rem;
}
.custom-alert-danger {
  background: #fdecea;
  color: #F44336;
  border: 1px solid #F44336;
}
.custom-alert-info {
  background: #e3f7fc;
  color: #2D5DA1;
  border: 1px solid #2D5DA1;
}
@media (max-width: 600px) {
  .custom-modal-content { padding: 1.1rem 0.5rem; min-width: 0; }
}
</style>
<script>
function openModal(id) {
  document.getElementById(id).classList.add('show');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('show');
  document.body.style.overflow = '';
}
window.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.custom-modal.show').forEach(function(modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    });
  }
});
</script>
	<thead>
		<tr>
			<th>Matricule</th>
			<th>Nom</th>
			<th>Prénom</th>
			<th>Classe</th>
			<th>Action</th>
		</tr>
	</thead>
	<tbody>
		{% for student in students %}
			<tr>
				<td>{{ student.matricule }}</td>
				<td>{{ student.last_name }}</td>
				<td>{{ student.first_name }}</td>
				<td>{{ student.classroom.name }}</td>
				<td><a href="/students/{{ student.id }}/" class="btn btn-sm btn-info">Détail</a></td>
			</tr>
		{% empty %}
			<tr><td colspan="5">Aucun élève trouvé.</td></tr>
		{% endfor %}
	</tbody>
</table>
</div>

<script src="{% static 'js/bootstrap.js' %}"></script>
{% endblock %}
